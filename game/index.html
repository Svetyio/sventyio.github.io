<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>Svetlyo Slot Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom, #000000, #1a1a1a);
      color: white;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
    }
    #container {
      position: relative;
      width: 100vw;
      max-width: 1000px;
      margin: 0 auto;
    }
    #gameCanvas, #sparkCanvas {
      display: block;
      margin: 25px auto 10px auto;
      background: #111;
      border: 8px solid #ffcc00;
      border-radius: 20px;
      box-shadow: 0 0 18px #ffcc00;
      max-width: 95vw;
      width: 95vw;
      height: 95vw;
      min-width: 220px;
      min-height: 220px;
      max-height: 380px;
      max-width: 380px;
      touch-action: none;
      position: absolute;
      left: 0; top: 0;
    }
    #gameCanvas { z-index: 1; position: relative; }
    #sparkCanvas { z-index: 3; pointer-events: none; }
    #container { position:relative; height: 380px; max-width: 380px; }
    @media (min-width: 600px) {
      #gameCanvas, #sparkCanvas {
        width: 340px;
        height: 340px;
        min-width: 290px;
        min-height: 290px;
        max-width: 380px;
        max-height: 380px;
      }
      #container { height: 380px; }
    }
    #info-row {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 16px auto 10px auto;
      width: 100%;
      max-width: 600px;
      flex-wrap: wrap;
    }
    .info-box {
      background: #222;
      border: 2px solid #888;
      border-radius: 10px;
      box-shadow: 0 0 8px #222;
      font-size: 16px;
      min-width: 80px;
      min-height: 32px;
      padding: 6px 14px;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      transition: color 0.5s, background 0.5s;
    }
    #coins { background-color: #2e8b57; }
    #lastWin { background-color: #8b0000; }
    #totalWin { background-color: #1e90ff; }

    #bets {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 12px auto 0 auto;
      width: 100%;
      max-width: 600px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 8px 18px;
      font-size: 16px;
      color: white;
      background-color: #222;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s, transform 0.15s, box-shadow 0.2s;
      margin: 0;
      min-width: 48px;
      min-height: 32px;
      outline: none;
      box-shadow: 0 1px 2px #0008;
      font-weight: 500;
      letter-spacing: 1px;
    }
    .btn.selected-bet,
    .btn:active.selected-bet {
      background-color: #00cc00 !important;
      color: #fff !important;
      box-shadow: 0 0 10px 2px #00cc00;
      font-weight: bold;
    }
    .btn:focus-visible:not(.selected-bet) {
      background-color: #444;
      color: #fff;
    }
    #spinBtn {
      background-color: #c00;
      border-radius: 50%;
      width: 90px;
      height: 90px;
      font-size: 26px;
      font-weight: bold;
      color: white;
      margin: 22px auto 10px auto;
      display: block;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 0 20px #800;
      border: none;
      outline: none;
      z-index: 1;
      position: relative;
      user-select: none;
      animation: pulseSpinBtn 1.2s infinite alternate;
    }
    @keyframes pulseSpinBtn {
      0% { box-shadow: 0 0 24px #e00; }
      100% { box-shadow: 0 0 44px #fff; transform: scale(1.05);}
    }
    #spinBtn:hover, #spinBtn:focus-visible {
      background-color: #e00;
      transform: scale(1.08);
    }
    #spinBtn.auto {
      background: linear-gradient(90deg, #0f0 0%, #c00 100%);
      color: #fff;
      animation: auto-spin-blink 1.2s infinite alternate;
      box-shadow: 0 0 38px #0f0;
    }
    @keyframes auto-spin-blink {
      0% { box-shadow: 0 0 24px #0f03; }
      100% { box-shadow: 0 0 54px #0f0; }
    }
    #restartBtn {
      background: #1e90ff;
      border-radius: 50%;
      width: 90px;
      height: 90px;
      font-size: 18px;
      font-weight: bold;
      color: white;
      margin: 22px auto 10px auto;
      display: block;
      transition: background 0.3s, transform 0.2s;
      box-shadow: 0 0 16px #1e90ff99;
      border: none;
      outline: none;
      z-index: 1;
      position: relative;
    }
    #restartBtn:hover, #restartBtn:focus-visible {
      background: #00ccff;
      transform: scale(1.05);
    }
    #winLabel {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 9px;
      font-size: 28px;
      font-weight: 900;
      color: #fff400;
      text-shadow: 0 0 12px #ff0, 0 2px 17px #fff;
      background: rgba(40,40,0,0.4);
      padding: 6px 22px;
      border-radius: 15px;
      opacity: 0;
      pointer-events: none;
      z-index: 10;
      transition: opacity 0.4s;
      white-space: nowrap;
    }
    #winLabel.active {
      opacity: 1 !important;
      pointer-events: auto;
      transition: none;
    }
    .small-title {
      font-size: 22px;
      font-weight: 600;
      margin: 16px auto 0 auto;
      letter-spacing: 1px;
      line-height: 1;
      max-width: 99vw;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    /* Double modal */
    #doubleModalBg {
      display: none;
      position: fixed;
      left:0; top:0; right:0; bottom:0;
      z-index: 1000;
      background: rgba(10,10,20,0.82);
      align-items: center;
      justify-content: center;
    }
    #doubleModalBg.active { display: flex; }
    #doubleModal {
      background: #181818;
      border-radius: 24px;
      border: 3px solid #fff;
      box-shadow: 0 0 30px #ffec70;
      padding: 30px 22px 18px 22px;
      min-width: 220px;
      min-height: 120px;
      max-width: 90vw;
      color: #fff;
      font-size: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: appear 0.5s;
    }
    @keyframes appear { from { scale: 0.8; opacity:0; } to { scale: 1; opacity:1; } }
    #doubleBtns {
      margin-top: 25px;
      display: flex;
      gap: 30px;
    }
    #doubleRed, #doubleGreen {
      padding: 12px 26px;
      font-size: 20px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      transition: box-shadow 0.15s, scale 0.1s, background 0.5s;
      box-shadow: 0 2px 12px #000a;
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      0% { transform: scale(1);}
      100% { transform: scale(1.13);}
    }
    #doubleRed { background: #e21; }
    #doubleRed:hover { box-shadow: 0 0 20px #e21b; scale:1.12; }
    #doubleGreen { background: #1c4; }
    #doubleGreen:hover { box-shadow: 0 0 20px #1c4b; scale:1.12; }
    #doubleResult {
      margin-top: 18px;
      font-size: 1.15em;
      color: #fff;
      font-weight: bold;
      min-height: 26px;
      letter-spacing: 1px;
      text-shadow: 0 0 4px #000, 0 0 16px #ff0;
    }
    @media (max-width: 500px) {
      #winLabel {
        font-size: 16px;
        padding: 3px 7px;
      }
      #spinBtn, #restartBtn { width: 60px; height: 60px; font-size: 13px; }
      #bets { gap: 3px; }
      .btn { font-size: 11px; min-height: 18px; padding: 4px 7px; }
      .info-box { font-size: 11px; min-width: 39px; min-height: 10px; padding: 2px 4px; }
      .small-title { font-size: 13px; }
      #doubleModal { font-size:14px; padding:18px 8px 12px 8px; }
      #doubleBtns { gap: 12px; }
      #doubleRed, #doubleGreen { font-size: 13px; padding: 8px 12px;}
    }
  </style>
</head>
<body>
  <div class="small-title">–î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ Svetlyo Games</div>
  <div id="container">
    <span id="winLabel"></span>
    <canvas id="gameCanvas"></canvas>
    <canvas id="sparkCanvas"></canvas>
  </div>
  <div id="info-row">
    <div class="info-box" id="coins">–ú–æ–Ω–µ—Ç–∏: 500</div>
    <div class="info-box" id="lastWin">–ü–æ—Å–ª–µ–¥–Ω–∞ –ø–µ—á–∞–ª–±–∞: 0</div>
    <div class="info-box" id="totalWin">–û–±—â–∞ –ø–µ—á–∞–ª–±–∞: 0</div>
  </div>
  <div id="bets">
    <button class="btn" onclick="setBet(20)">20</button>
    <button class="btn" onclick="setBet(40)">40</button>
    <button class="btn" onclick="setBet(60)">60</button>
    <button class="btn" onclick="setBet(100)">100</button>
    <button class="btn" onclick="setBet(200)">200</button>
  </div>
  <button id="spinBtn" onclick="userSpinClick()">–°–ü–ò–ù</button>
  <button id="restartBtn" onclick="restartGame()" style="display:none">–ù–æ–≤–∞ –∏–≥—Ä–∞</button>
  <!-- Double Modal -->
  <div id="doubleModalBg">
    <div id="doubleModal">
      <div id="doubleText">–£–¥–≤–æ–∏ –ø–µ—á–∞–ª–±–∞—Ç–∞ —Å–∏!</div>
      <div id="doubleBtns">
        <button id="doubleRed">–ß–µ—Ä–≤–µ–Ω–æ</button>
        <button id="doubleGreen">–ó–µ–ª–µ–Ω–æ</button>
      </div>
      <div id="doubleResult"></div>
    </div>
  </div>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const sparkCanvas = document.getElementById('sparkCanvas');
    const sparkCtx = sparkCanvas.getContext('2d');
    const winLabel = document.getElementById('winLabel');
    const spinBtn = document.getElementById('spinBtn');
    const restartBtn = document.getElementById('restartBtn');

    // Double or Nothing Modal
    const doubleModalBg = document.getElementById('doubleModalBg');
    const doubleText = document.getElementById('doubleText');
    const doubleResult = document.getElementById('doubleResult');
    const doubleRed = document.getElementById('doubleRed');
    const doubleGreen = document.getElementById('doubleGreen');

    const FRUITS = ['üçé', 'üçí', 'üçá', 'üçÄ', 'üçâ'];
    const GRID_SIZE = 5;

    let selectedBet = 20;
    let coins = 500;
    let lastWin = 0;
    let totalWin = 0;
    let grid = [];
    let spinning = false;
    let spinAnimFrame = 0;
    let spinTargetGrid = [];
    let winLabelTimeout = null;
    let winFlash = false;
    let winFlashType = null;
    let winFlashLines = [];
    let doublePending = false;
    let doubleAmount = 0;
    let noWinCount = 0;
    let animCoins = coins, animLastWin = lastWin, animTotalWin = totalWin;

    let autoSpin = false;
    let autoSpinInterval = null;
    let holdTimeout = null;
    let holdingSpin = false;
    let sparks = [];

    function resizeCanvas() {
      let size = Math.min(window.innerWidth * 0.95, 380, window.innerHeight * 0.65);
      size = Math.max(size, 220);
      canvas.width = size;
      canvas.height = size;
      sparkCanvas.width = size;
      sparkCanvas.height = size;
      drawGrid();
    }
    window.addEventListener('resize', resizeCanvas);

    function saveStats() {
      localStorage.setItem('slot_coins', coins);
      localStorage.setItem('slot_lastWin', lastWin);
      localStorage.setItem('slot_totalWin', totalWin);
    }
    function loadStats() {
      coins = Number(localStorage.getItem('slot_coins')) || 500;
      lastWin = Number(localStorage.getItem('slot_lastWin')) || 0;
      totalWin = Number(localStorage.getItem('slot_totalWin')) || 0;
      animCoins = coins;
      animLastWin = lastWin;
      animTotalWin = totalWin;
    }

    function setBet(bet) {
      selectedBet = bet;
      document.querySelectorAll('#bets .btn').forEach(btn => {
        btn.classList.remove('selected-bet');
        if (parseInt(btn.innerText) === bet) {
          btn.classList.add('selected-bet');
        }
      });
    }

    // –ü–æ-–≤–∏—Å–æ–∫ —à–∞–Ω—Å –∑–∞ –ø–µ—á–∞–ª–±–∞ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞–Ω–∞ –ø–µ—á–∞–ª–±–∞ —Å–ª–µ–¥ —Å–µ—Ä–∏—è –∑–∞–≥—É–±–∏
    function generateGrid() {
      let arr = [];
      let r = Math.random();
      let forceWin = noWinCount >= 5;
      if (r < 0.40 || forceWin) {
        // —Ä–µ–¥
        let winRow = Math.floor(Math.random() * GRID_SIZE);
        let fruit = FRUITS[Math.floor(Math.random() * FRUITS.length)];
        for (let row = 0; row < GRID_SIZE; row++) {
          let rowData = [];
          for (let col = 0; col < GRID_SIZE; col++) {
            if (row === winRow) rowData.push(fruit);
            else rowData.push(randomFruit());
          }
          arr.push(rowData);
        }
      } else if (r < 0.63) {
        // –∫–æ–ª–æ–Ω–∞
        let winCol = Math.floor(Math.random() * GRID_SIZE);
        let fruit = FRUITS[Math.floor(Math.random() * FRUITS.length)];
        for (let row = 0; row < GRID_SIZE; row++) {
          let rowData = [];
          for (let col = 0; col < GRID_SIZE; col++) {
            if (col === winCol) rowData.push(fruit);
            else rowData.push(randomFruit());
          }
          arr.push(rowData);
        }
      } else if (r < 0.75) {
        // –¥–∏–∞–≥–æ–Ω–∞–ª
        let mainDiag = Math.random() < 0.5;
        let fruit = FRUITS[Math.floor(Math.random() * FRUITS.length)];
        for (let row = 0; row < GRID_SIZE; row++) {
          let rowData = [];
          for (let col = 0; col < GRID_SIZE; col++) {
            if ((mainDiag && row === col) || (!mainDiag && col === GRID_SIZE - 1 - row)) rowData.push(fruit);
            else rowData.push(randomFruit());
          }
          arr.push(rowData);
        }
      } else {
        for (let row = 0; row < GRID_SIZE; row++) {
          let rowData = [];
          for (let col = 0; col < GRID_SIZE; col++) {
            rowData.push(randomFruit());
          }
          arr.push(rowData);
        }
      }
      return arr;
    }

    function randomFruit() {
      return FRUITS[Math.floor(Math.random() * FRUITS.length)];
    }

    function getWinningLines(grid) {
      let lines = [];
      for (let row = 0; row < GRID_SIZE; row++) {
        if (grid[row].every(fruit => fruit === grid[row][0])) {
          lines.push({type:'row', index:row, fruit:grid[row][0]});
        }
      }
      for (let col = 0; col < GRID_SIZE; col++) {
        let colFruits = [];
        for (let row = 0; row < GRID_SIZE; row++) colFruits.push(grid[row][col]);
        if (colFruits.every(fruit => fruit === colFruits[0])) {
          lines.push({type:'col', index:col, fruit:colFruits[0]});
        }
      }
      let diag1 = [];
      for (let i = 0; i < GRID_SIZE; i++) diag1.push(grid[i][i]);
      if (diag1.every(fruit => fruit === diag1[0])) {
        lines.push({type:'diag', index:0, fruit:diag1[0]});
      }
      let diag2 = [];
      for (let i = 0; i < GRID_SIZE; i++) diag2.push(grid[i][GRID_SIZE-1-i]);
      if (diag2.every(fruit => fruit === diag2[0])) {
        lines.push({type:'diag', index:1, fruit:diag2[0]});
      }
      return lines;
    }

    function getWinScore(lines) {
      let score = 0;
      for(const line of lines) {
        if(line.type==="row") score+=100;
        else if(line.type==="col") score+=150;
        else if(line.type==="diag") score+=200;
      }
      return score;
    }

    function triggerWinFlash(lines) {
      winFlash = true;
      winFlashLines = lines;
      if(lines.some(l=>l.type==="diag")) winFlashType="diag";
      else if(lines.some(l=>l.type==="col")) winFlashType="col";
      else if(lines.some(l=>l.type==="row")) winFlashType="row";
      winLabel.classList.add("active");
      createSparks();
    }

    function clearWinFlash() {
      winFlash = false;
      winLabel.classList.remove("active");
      winFlashType = null;
      winFlashLines = [];
    }

    function showWinLabel(win) {
      winLabel.textContent = `–ü–ï–ß–ê–õ–ë–ê +${win}`;
      winLabel.classList.add("active");
    }

    function drawGrid() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const cellSize = canvas.width / (GRID_SIZE + 0.16);
      const margin = cellSize * 0.13;
      ctx.save();
      ctx.fillStyle = "#00c800";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.restore();
      const offsetX = (canvas.width - (GRID_SIZE * cellSize + (GRID_SIZE - 1) * margin)) / 2;
      const offsetY = (canvas.height - (GRID_SIZE * cellSize + (GRID_SIZE - 1) * margin)) / 2;

      // –°–≤–µ—Ç–µ–Ω–µ –Ω–∞ –ø–µ—á–µ–ª–∏–≤—à–∏—Ç–µ –ø–ª–æ–¥–æ–≤–µ
      let highlightCells = Array(GRID_SIZE).fill().map(()=>Array(GRID_SIZE).fill(false));
      for(const line of winFlashLines) {
        if(line.type==="row") for(let c=0;c<GRID_SIZE;c++) highlightCells[line.index][c]=true;
        if(line.type==="col") for(let r=0;r<GRID_SIZE;r++) highlightCells[r][line.index]=true;
        if(line.type==="diag"&&line.index===0) for(let i=0;i<GRID_SIZE;i++) highlightCells[i][i]=true;
        if(line.type==="diag"&&line.index===1) for(let i=0;i<GRID_SIZE;i++) highlightCells[i][GRID_SIZE-1-i]=true;
      }

      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          const x = offsetX + col * (cellSize + margin);
          const y = offsetY + row * (cellSize + margin);

          ctx.save();
          ctx.fillStyle = '#111';
          ctx.globalAlpha = 0.97;
          ctx.fillRect(x, y, cellSize, cellSize);
          ctx.restore();

          // –ü–ª–∞–≤–Ω–æ —Ä–∞–∑–∫–ª–∞—â–∞–Ω–µ –∏ halo, –∞–∫–æ –ø–µ—á–µ–ª–∏—à!
          let shake = 0, halo = 0;
          if (highlightCells[row][col] && winFlash) {
            halo = 1;
            shake = Math.sin(Date.now()/45 + row+col)*3;
          }
          // Halo
          if (halo) {
            ctx.save();
            ctx.globalAlpha = 0.35+0.15*Math.sin(Date.now()/120+row+col);
            ctx.beginPath();
            ctx.arc(x+cellSize/2, y+cellSize/2, cellSize*0.38, 0, 2*Math.PI);
            ctx.fillStyle = "rgba(255,255,0,0.36)";
            ctx.filter = "blur(6px)";
            ctx.fill();
            ctx.restore();
          }
          // –ï–º–æ–¥–∂–∏
          ctx.save();
          ctx.font = `${Math.floor(cellSize * 0.46)}px serif`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillStyle = 'white';
          ctx.shadowColor = '#444';
          ctx.shadowBlur = 6;
          ctx.translate(x + cellSize / 2 + shake, y + cellSize / 2 + 0.5 + shake);
          ctx.fillText(grid[row][col], 0, 0);
          ctx.restore();
        }
      }
      // –õ–∏–Ω–∏—è –≤—ä—Ä—Ö—É –ø–µ—á–µ–ª–∏–≤—à–∞—Ç–∞ –ª–∏–Ω–∏—è
      if (winFlash && winFlashLines.length > 0) {
        for(const line of winFlashLines) {
          ctx.save();
          if(line.type==="row") ctx.strokeStyle = "#ffe047";
          else if(line.type==="col") ctx.strokeStyle = "#86e0fa";
          else if(line.type==="diag") ctx.strokeStyle = "#ff88e0";
          ctx.lineWidth = cellSize*0.15;
          ctx.globalAlpha = 0.25+0.2*Math.abs(Math.sin(Date.now()/300));
          ctx.beginPath();
          if(line.type==="row") {
            const y = offsetY + line.index * (cellSize + margin) + cellSize/2;
            ctx.moveTo(offsetX, y);
            ctx.lineTo(offsetX + GRID_SIZE * cellSize + (GRID_SIZE-1)*margin, y);
          } else if(line.type==="col") {
            const x = offsetX + line.index * (cellSize + margin) + cellSize/2;
            ctx.moveTo(x, offsetY);
            ctx.lineTo(x, offsetY + GRID_SIZE * cellSize + (GRID_SIZE-1)*margin);
          } else if(line.type==="diag" && line.index===0) {
            ctx.moveTo(offsetX, offsetY);
            ctx.lineTo(offsetX + GRID_SIZE * (cellSize+margin)-margin, offsetY + GRID_SIZE * (cellSize+margin)-margin);
          } else if(line.type==="diag" && line.index===1) {
            ctx.moveTo(offsetX + GRID_SIZE * (cellSize+margin)-margin, offsetY);
            ctx.lineTo(offsetX, offsetY + GRID_SIZE * (cellSize+margin)-margin);
          }
          ctx.stroke();
          ctx.restore();
        }
      }
      updateInfo();
    }

    function animateNumber(current, target) {
      if (Math.abs(current-target)<0.5) return target;
      return current + (target-current)*0.15;
    }

    function updateInfo() {
      animCoins = animateNumber(animCoins, coins);
      animLastWin = animateNumber(animLastWin, lastWin);
      animTotalWin = animateNumber(animTotalWin, 
